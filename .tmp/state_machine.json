{
  "Comment": "Run Iceberg delete compaction on EMR - supports multiple tables",
  "StartAt": "AddEmrStep",
  "States": {
    "AddEmrStep": {
      "Type": "Task",
      "Resource": "arn:aws:states:::elasticmapreduce:addStep.sync",
      "Parameters": {
        "ClusterId": "j-NKZW1C1DUUWZ",
        "Step": {
          "Name": "iceberg_delete_compaction",
          "ActionOnFailure": "CONTINUE",
          "HadoopJarStep": {
            "Jar": "command-runner.jar",
            "Args.$": "States.Array('bash', '-lc', States.Format('timeout 60m bash -lc \\'TABLE_IDENT={} spark-shell --master yarn --deploy-mode client --num-executors 4 --executor-cores 2 --executor-memory 4g --conf spark.sql.extensions=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions --conf spark.sql.catalog.glue_catalog=org.apache.iceberg.spark.SparkCatalog --conf spark.sql.catalog.glue_catalog.catalog-impl=org.apache.iceberg.aws.glue.GlueCatalog --conf spark.sql.catalog.glue_catalog.io-impl=org.apache.iceberg.aws.s3.S3FileIO --conf spark.sql.catalog.glue_catalog.warehouse={} --conf spark.hadoop.fs.s3a.aws.credentials.provider=com.amazonaws.auth.InstanceProfileCredentialsProvider --conf spark.dynamicAllocation.enabled=true --conf spark.dynamicAllocation.minExecutors=1 --conf spark.dynamicAllocation.maxExecutors=20 -i /home/hadoop/compaction.scala\\' <<< \\':quit\\'', $.glue_table, $.warehouse_s3))"
          }
        }
      },
      "End": true
    }
  }
}
